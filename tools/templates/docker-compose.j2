version: "3.9"

services:
{% for router in routers %}
  {{ router.name }}:
    image: frrouting/frr:v8.4.1
    container_name: {{ router.name }}
    hostname: {{ router.name }}
    volumes:
      - ./frr/{{ router.name }}/frr.conf:/etc/frr/frr.conf:ro
      - ./frr/{{ router.name }}/daemons:/etc/frr/daemons:ro
      - ./bin/:/usr/local/bin/:ro
{% if pcap_pipeline.enabled %}
      - {{ pcap_pipeline.shared_volume }}:/captures
{% endif %}
    networks:
{% for iface in router.interfaces %}
      {{ iface.bridge }}:
        ipv4_address: {{ iface.ipv4_address }}
{% endfor %}
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
{% if router.env %}
    environment:
{% for key, value in router.env.items() %}
      {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}
{% endfor %}
  attack_controller:
    build: ./services/attack_controller
    environment:
      LAB_CONFIG: /lab/lab_config.yaml
    volumes:
      - ./lab_config.yaml:/lab/lab_config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
{% for router in routers %}
      - {{ router.name }}
{% endfor %}
    networks:
      lab_mgmt:
        ipv4_address: 10.255.0.10

  observer:
    build: ./services/observer
    environment:
      ATTACK_CONTROLLER_URL: http://attack_controller:9000
      LAB_CONFIG: /lab/lab_config.yaml
    volumes:
      - {{ pcap_pipeline.shared_volume }}:/captures:ro
      - ./lab_config.yaml:/lab/lab_config.yaml:ro
      - ./topology-metadata.json:/lab/topology-metadata.json:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - attack_controller
    networks:
      lab_mgmt:
        ipv4_address: 10.255.0.20
    ports:
      - "8080:8080"

networks:
  lab_mgmt:
    driver: bridge
    ipam:
      config:
        - subnet: 10.255.0.0/24
{% for link_name, link in links.items() %}
  {{ link_name }}:
    driver: bridge
    ipam:
      config:
        - subnet: {{ link.ipv4_subnet }}
{% endfor %}
{% if pcap_pipeline.enabled %}
volumes:
  {{ pcap_pipeline.shared_volume }}:
    driver: local
{% endif %}
